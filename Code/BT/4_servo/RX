#include <SoftwareSerial.h>
#include <Servo.h>

//13
//12
//11
//10 순으로 motor pin 연결
#define pin_front 13
#define pin_side 12
#define pin_delt 11
#define pin_elbow 10

#define num_of_joint 4

//4 digit 씩 4개
#define first_digit 1000000000000
#define second_digit 100000000
#define third_digit 10000

SoftwareSerial BTSerial(2, 3);  // BTSerial(Rx, Tx)

//servo object 생성
Servo front;
Servo side;
Servo delt;
Servo elbow;

static int temp_val = 0;  //읽은 값 임시 저장 (1개만 필요)

int cur_front = 0;
int cur_side = 0;
int cur_delt = 0;
int cur_elbow = 0;

static int prev_front = 0;
static int prev_side = 0;
static int prev_delt = 0;
static int prev_elbow = 0;

void setup() {
  Serial.begin(9600);
  BTSerial.begin(38400);

  front.attach(pin_front);
  side.attach(pin_side);
  delt.attach(pin_delt);
  elbow.attach(pin_elbow);

  pinMode(pin_front, OUTPUT);
  pinMode(pin_side, OUTPUT);
  pinMode(pin_delt, OUTPUT);
  pinMode(pin_elbow, OUTPUT);
}


//아마 이 함수에서 오류 날 듯, 오류나면, loop문에 하나씩 선언 해주는 수 밖에 없을 듯
//myservo를 어떻게 정의하면 될지 고민해보기

void moveMotor(int cur_val, int prev_val, Servo &name, int servo_pin_name) {
  // 값을 ±4 이상의 변화에서만 모터가 작동되도록하여 떨림현상 제거(값 조정가능)
  if ((cur_val > prev_val + 4) | (cur_val < prev_val - 4)) {
    name.attach(servo_pin_name);
    name.write(cur_val);  //
    prev_val = cur_val;
  }
  name.detach();
}


void loop() {
  if (BTSerial.available()) {
    // --- 수신되는 Var 값을 체크 후 서보 모터 구동 루틴 ---
    temp_val = BTSerial.read();
    Serial.print("temp_val:");
    Serial.println(temp_val);  //값 출력해봄

    //각 자리수별로 읽힌 값 출력
    cur_front = temp_val / first_digit;
    temp_val = temp_val % first_digit;

    cur_side = temp_val / second_digit;
    temp_val = temp_val % second_digit;

    cur_delt = temp_val / third_digit;
    temp_val = temp_val % third_digit;

    cur_elbow = temp_val;
  }

  moveMotor(cur_front, prev_front, front, pin_front);
  moveMotor(cur_side, prev_side, side, pin_side);
  moveMotor(cur_delt, prev_delt, delt, pin_delt);
  moveMotor(cur_elbow, prev_elbow, elbow, pin_elbow);
}
